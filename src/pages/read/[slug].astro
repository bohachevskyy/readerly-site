---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { allStories, type Story } from "../../data/stories";

export function getStaticPaths() {
  const stories = allStories();
  return stories.map((story) => ({
    params: { slug: story.slug },
    props: { story },
  }));
}

interface Props {
  story: Story;
}

const { story } = Astro.props;
const languages = Object.keys(story.translations);

const LANGUAGE_LABELS: Record<string, string> = {
  es: "Español",
  uk: "Українська",
  fr: "Français",
  de: "Deutsch",
  pt: "Português",
  it: "Italiano",
  pl: "Polski",
  ja: "日本語",
  ko: "한국어",
  zh: "中文",
  ar: "العربية",
  hi: "हिन्दी",
  tr: "Türkçe",
  nl: "Nederlands",
  sv: "Svenska",
};

function getLanguageLabel(code: string): string {
  return LANGUAGE_LABELS[code] ?? code.toUpperCase();
}

// Tokenize text into paragraphs of words, tracking each word's character offset
// in the original text. The offset is used as the word's unique ID to match the
// position-indexed keys in the JSON data.
interface Token {
  word: string;
  offset: number;
}

function tokenizeWithOffsets(text: string): Token[][] {
  const paragraphs: Token[][] = [];
  const rawParagraphs = text.split("\n\n");
  let charPos = 0;

  for (let pIdx = 0; pIdx < rawParagraphs.length; pIdx++) {
    const p = rawParagraphs[pIdx];
    const tokens: Token[] = [];
    const re = /\S+/g;
    let m: RegExpExecArray | null;
    while ((m = re.exec(p)) !== null) {
      tokens.push({ word: m[0], offset: charPos + m.index });
    }
    paragraphs.push(tokens);
    charPos += p.length;
    // Account for the "\n\n" separator between paragraphs
    if (pIdx < rawParagraphs.length - 1) {
      charPos += 2;
    }
  }

  return paragraphs;
}

const paragraphs = tokenizeWithOffsets(story.text);

const siteUrl = Astro.site?.toString() ?? "https://readerly.ai";
const pageUrl = new URL(Astro.url.pathname, siteUrl).toString();

const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: story.title,
  description: story.description,
  url: pageUrl,
  inLanguage: "en",
  publisher: {
    "@type": "Organization",
    name: "Readerly",
    url: siteUrl,
  },
  isAccessibleForFree: true,
  educationalLevel: story.level,
};
---

<BaseLayout
  title={`${story.title} — Read on Readerly`}
  description={story.description}
  ogType="article"
  jsonLdOverride={articleJsonLd}
>
  <!-- Header -->
  <header class="border-b border-emerald-100 bg-white">
    <nav class="container flex items-center justify-between py-6">
      <div class="flex items-center gap-3 text-lg font-semibold text-ink">
        <a href="/" class="flex items-center gap-3 hover:opacity-80 transition">
          <span class="flex h-9 w-9 items-center justify-center rounded-full bg-ink text-white">
            R
          </span>
          Readerly
        </a>
      </div>
      <div class="flex items-center gap-4">
        <a
          class="text-sm font-medium text-muted hover:text-ink transition"
          href="/read/"
        >
          All Stories
        </a>
        <a
          class="rounded-full border border-emerald-200 px-5 py-2 text-sm font-medium text-ink transition hover:border-emerald-400"
          href="https://app.readerly.ai"
          target="_blank"
          rel="noopener"
        >
          Open Readerly
        </a>
      </div>
    </nav>
  </header>

  <main class="min-h-screen bg-white">
    <!-- Story toolbar -->
    <div class="border-b border-emerald-100 bg-soft/50">
      <div class="container flex flex-col gap-3 py-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <a href="/read/" class="text-sm text-muted hover:text-ink transition inline-flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            Back to stories
          </a>
          <h1 class="mt-1 text-xl font-semibold text-ink">{story.title}</h1>
          {story.level && (
            <span class="mt-1 inline-block rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-semibold text-emerald-700">
              {story.level}
            </span>
          )}
        </div>

        <!-- Language switcher -->
        <div class="flex items-center gap-2">
          <label for="lang-select" class="text-xs font-medium uppercase tracking-wider text-muted">Translate to:</label>
          <div class="relative">
            <select
              id="lang-select"
              class="appearance-none rounded-lg border border-emerald-200 bg-white py-1.5 pl-3 pr-8 text-sm font-medium text-ink shadow-sm transition hover:border-emerald-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 cursor-pointer"
            >
              {languages.map((lang) => (
                <option value={lang}>{getLanguageLabel(lang)}</option>
              ))}
            </select>
            <svg class="pointer-events-none absolute right-2 top-1/2 h-4 w-4 -translate-y-1/2 text-muted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Story text -->
    <article class="container py-10">
      <div id="story-content" class="story-text mx-auto max-w-[680px] font-serif text-lg leading-[1.9] text-ink">
        {paragraphs.map((tokens) => (
          <p class="mb-6">
            {tokens.map((token, i) => (
              <>
                <span
                  class="word cursor-pointer rounded px-[1px] transition-colors duration-150 hover:bg-emerald-100"
                  data-word-id={String(token.offset)}
                >{token.word}</span>{i < tokens.length - 1 ? " " : ""}
              </>
            ))}
          </p>
        ))}
      </div>
    </article>

    <!-- Word popup (hidden by default) -->
    <div
      id="tooltip"
      class="pointer-events-none fixed z-50 opacity-0 transition-opacity duration-150"
      style="top:0;left:0"
    >
      <div class="rounded-2xl border border-emerald-200 bg-white shadow-lg w-[320px]">
        <!-- Header: word + speak + close -->
        <div class="flex items-start justify-between gap-2 px-5 pt-4 pb-2">
          <div class="flex items-center gap-2">
            <p id="tooltip-word" class="text-xl font-bold text-ink"></p>
            <button
              id="tooltip-speak"
              type="button"
              title="Pronounce word"
              class="flex h-7 w-7 shrink-0 items-center justify-center rounded-full text-muted transition hover:bg-emerald-100 hover:text-ink"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072M17.95 6.05a8 8 0 010 11.9M11 5L6 9H2v6h4l5 4V5z" />
              </svg>
            </button>
          </div>
          <button
            id="tooltip-close"
            type="button"
            title="Close"
            class="flex h-7 w-7 shrink-0 items-center justify-center rounded-full text-muted transition hover:bg-emerald-100 hover:text-ink"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Part of speech -->
        <p id="tooltip-pos" class="px-5 text-sm italic text-muted"></p>

        <!-- Sections -->
        <div class="mt-3 space-y-3 px-5 pb-2">
          <!-- Translation -->
          <div id="tooltip-translation-section">
            <p class="text-xs font-medium text-muted">Translation</p>
            <p id="tooltip-translation" class="mt-0.5 text-base font-semibold text-ink"></p>
          </div>

          <!-- Example -->
          <div id="tooltip-example-section">
            <p class="text-xs font-medium text-muted">Example</p>
            <p id="tooltip-example" class="mt-0.5 text-sm italic leading-relaxed text-ink/70"></p>
          </div>
        </div>

        <!-- Save word CTA -->
        <div class="px-5 pb-4 pt-2">
          <a
            href={story.appUrl || "https://app.readerly.ai"}
            target="_blank"
            rel="noopener"
            class="flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-400 px-4 py-2.5 text-sm font-semibold text-white transition hover:bg-emerald-500"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            Save to my dictionary
          </a>
          <p class="mt-1.5 text-center text-[11px] text-muted">Free account required</p>
        </div>
      </div>
    </div>
  </main>

  <!-- CTA Section -->
  <section class="bg-emerald-50 border-t border-emerald-100">
    <div class="container py-12 text-center">
      <h2 class="text-2xl font-semibold text-ink">
        Want to save words and practice them?
      </h2>
      <p class="mt-3 text-muted max-w-lg mx-auto">
        Open Readerly to build your personal vocabulary with spaced repetition — completely free.
      </p>
      <div class="mt-6 flex flex-col sm:flex-row gap-4 justify-center">
        <a
          href="/read/"
          class="inline-flex items-center justify-center rounded-full border border-emerald-200 bg-white px-6 py-3 text-sm font-semibold text-ink transition hover:border-emerald-400"
        >
          Browse More Stories
        </a>
        <a
          href={story.appUrl || "https://app.readerly.ai"}
          target="_blank"
          rel="noopener"
          class="inline-flex items-center justify-center rounded-full bg-emerald-500 px-6 py-3 text-sm font-semibold text-white shadow-soft transition hover:bg-emerald-600"
        >
          Open Readerly App
        </a>
      </div>
    </div>
  </section>

  <footer class="border-t border-emerald-100 bg-white">
    <div class="container flex flex-col items-start justify-between gap-4 py-8 text-sm text-muted sm:flex-row sm:items-center">
      <p>&copy; {new Date().getFullYear()} Readerly</p>
      <div class="flex gap-4">
        <a class="hover:text-ink" href="mailto:hello@readerly.ai">Contact</a>
        <span>Privacy available on request</span>
      </div>
    </div>
  </footer>

  <script define:vars={{ slug: story.slug, languages }}>
    // --- State ---
    let currentLang = localStorage.getItem("readerly-lang") || languages[0];
    if (!languages.includes(currentLang)) currentLang = languages[0];

    // --- Lazy-loaded translations and words ---
    let translations = {};
    let words = {};
    let isLoading = true;
    let loadError = false;

    // Fetch translations on page load
    (async function loadTranslations() {
      try {
        const res = await fetch(`/api/stories/${slug}/translations.json/`);
        if (!res.ok) throw new Error("Failed to load translations");
        const data = await res.json();
        translations = data.translations || {};
        words = data.words || {};
        isLoading = false;
        // If tooltip is open, refresh it with loaded data
        if (activeWord) showTooltipForWord(activeWord);
      } catch (err) {
        console.error("Error loading translations:", err);
        isLoading = false;
        loadError = true;
      }
    })();

    const tooltip = document.getElementById("tooltip");
    const elWord = document.getElementById("tooltip-word");
    const elPos = document.getElementById("tooltip-pos");
    const elTranslation = document.getElementById("tooltip-translation");
    const elExample = document.getElementById("tooltip-example");
    const elExampleSection = document.getElementById("tooltip-example-section");
    let activeWord = null;

    // --- Speech synthesis ---
    const speakBtn = document.getElementById("tooltip-speak");

    function speakWord(word) {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(word);
      utterance.lang = "en-US";
      utterance.rate = 0.9;
      window.speechSynthesis.speak(utterance);
    }

    speakBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if (activeWord) {
        const id = activeWord.dataset.wordId;
        const info = words[id];
        speakWord(info?.word || activeWord.textContent);
      }
    });

    // --- Close button ---
    document.getElementById("tooltip-close").addEventListener("click", (e) => {
      e.stopPropagation();
      hideTooltip();
    });

    // --- Language switcher ---
    const langSelect = document.getElementById("lang-select");

    function setActiveLang(lang) {
      currentLang = lang;
      localStorage.setItem("readerly-lang", lang);
      langSelect.value = lang;
      if (activeWord) showTooltipForWord(activeWord);
    }

    setActiveLang(currentLang);

    langSelect.addEventListener("change", () => {
      setActiveLang(langSelect.value);
    });

    // --- Tooltip logic ---
    function showTooltipForWord(span) {
      const wordId = span.dataset.wordId;
      const displayText = span.textContent;

      // Handle loading state
      if (isLoading) {
        elWord.textContent = displayText.toLowerCase();
        elPos.style.display = "none";
        elTranslation.textContent = "Loading...";
        elExampleSection.style.display = "none";
      } else if (loadError) {
        elWord.textContent = displayText.toLowerCase();
        elPos.style.display = "none";
        elTranslation.textContent = "Failed to load";
        elExampleSection.style.display = "none";
      } else {
        const dict = translations[currentLang] || {};
        const translation = dict[wordId];
        const wordInfo = words[wordId];

        // Word (use base form from dictionary, fall back to display text)
        elWord.textContent = wordInfo?.word || displayText.toLowerCase();

        // Part of speech
        if (wordInfo && wordInfo.pos) {
          elPos.textContent = wordInfo.pos;
          elPos.style.display = "";
        } else {
          elPos.style.display = "none";
        }

        // Translation
        if (translation) {
          elTranslation.textContent = translation;
        } else {
          elTranslation.textContent = "—";
        }

        // Example
        if (wordInfo && wordInfo.example) {
          elExample.textContent = wordInfo.example;
          elExampleSection.style.display = "";
        } else {
          elExampleSection.style.display = "none";
        }
      }

      // Position tooltip
      const rect = span.getBoundingClientRect();
      const tooltipEl = tooltip.firstElementChild;
      tooltip.style.opacity = "1";
      tooltip.classList.remove("pointer-events-none");

      // Measure
      tooltip.style.left = "0px";
      tooltip.style.top = "0px";
      const tRect = tooltipEl.getBoundingClientRect();

      let left = rect.left + rect.width / 2 - tRect.width / 2;
      let top = rect.top - tRect.height - 8;

      // Keep within viewport
      if (left < 8) left = 8;
      if (left + tRect.width > window.innerWidth - 8)
        left = window.innerWidth - tRect.width - 8;
      if (top < 8) top = rect.bottom + 8;

      tooltip.style.left = left + "px";
      tooltip.style.top = top + "px";
    }

    function hideTooltip() {
      tooltip.style.opacity = "0";
      tooltip.classList.add("pointer-events-none");
      if (activeWord) {
        activeWord.classList.remove("bg-emerald-200");
        activeWord = null;
      }
    }

    // --- Event listeners ---
    document.getElementById("story-content").addEventListener("click", (e) => {
      const span = e.target.closest(".word");
      if (!span) {
        hideTooltip();
        return;
      }
      if (activeWord === span) {
        hideTooltip();
        return;
      }
      if (activeWord) activeWord.classList.remove("bg-emerald-200");

      activeWord = span;
      span.classList.add("bg-emerald-200");
      showTooltipForWord(span);
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".word") && !e.target.closest("#tooltip")) {
        hideTooltip();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") hideTooltip();
    });

    function repositionTooltip() {
      if (activeWord) showTooltipForWord(activeWord);
    }
    window.addEventListener("scroll", repositionTooltip, { passive: true });
    window.addEventListener("resize", repositionTooltip, { passive: true });
  </script>
</BaseLayout>
