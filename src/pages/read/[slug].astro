---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { allStories, type Story } from "../../data/stories";

export function getStaticPaths() {
  const stories = allStories();
  return stories.map((story) => ({
    params: { slug: story.slug },
    props: { story },
  }));
}

interface Props {
  story: Story;
}

const { story } = Astro.props;
const languages = Object.keys(story.translations);

const LANGUAGE_LABELS: Record<string, string> = {
  es: "Español",
  uk: "Українська",
  fr: "Français",
  de: "Deutsch",
  pt: "Português",
  it: "Italiano",
  pl: "Polski",
  ja: "日本語",
  ko: "한국어",
  zh: "中文",
  ar: "العربية",
  hi: "हिन्दी",
  tr: "Türkçe",
  nl: "Nederlands",
  sv: "Svenska",
};

function getLanguageLabel(code: string): string {
  return LANGUAGE_LABELS[code] ?? code.toUpperCase();
}

// Split text into paragraphs and then words, preserving punctuation visually
function tokenize(text: string) {
  const paragraphs = text.split("\n\n");
  return paragraphs.map((p) => {
    // Split on whitespace, keeping each token
    return p.split(/\s+/).filter((w) => w.length > 0);
  });
}

const paragraphs = tokenize(story.text);

// Normalize a display word for dictionary lookup: lowercase, strip punctuation
function normalize(word: string): string {
  return word.toLowerCase().replace(/[^a-zA-Z'-]/g, "");
}
---

<BaseLayout
  title={`${story.title} — Read on Readerly`}
  description={story.description}
>
  <!-- Header -->
  <header class="border-b border-emerald-100 bg-white">
    <nav class="container flex items-center justify-between py-6">
      <div class="flex items-center gap-3 text-lg font-semibold text-ink">
        <a href="/" class="flex items-center gap-3 hover:opacity-80 transition">
          <span class="flex h-9 w-9 items-center justify-center rounded-full bg-ink text-white">
            R
          </span>
          Readerly
        </a>
      </div>
      <div class="flex items-center gap-4">
        <a
          class="text-sm font-medium text-muted hover:text-ink transition"
          href="/read/"
        >
          All Stories
        </a>
        <a
          class="rounded-full border border-emerald-200 px-5 py-2 text-sm font-medium text-ink transition hover:border-emerald-400"
          href="https://app.readerly.ai"
          target="_blank"
          rel="noopener"
        >
          Open Readerly
        </a>
      </div>
    </nav>
  </header>

  <main class="min-h-screen bg-white">
    <!-- Story toolbar -->
    <div class="border-b border-emerald-100 bg-soft/50">
      <div class="container flex flex-col gap-3 py-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <a href="/read/" class="text-sm text-muted hover:text-ink transition inline-flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            Back to stories
          </a>
          <h1 class="mt-1 text-xl font-semibold text-ink">{story.title}</h1>
          {story.level && (
            <span class="mt-1 inline-block rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-semibold text-emerald-700">
              {story.level}
            </span>
          )}
        </div>

        <!-- Language switcher -->
        <div class="flex items-center gap-2">
          <label for="lang-select" class="text-xs font-medium uppercase tracking-wider text-muted">Translate to:</label>
          <div class="relative">
            <select
              id="lang-select"
              class="appearance-none rounded-lg border border-emerald-200 bg-white py-1.5 pl-3 pr-8 text-sm font-medium text-ink shadow-sm transition hover:border-emerald-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 cursor-pointer"
            >
              {languages.map((lang) => (
                <option value={lang}>{getLanguageLabel(lang)}</option>
              ))}
            </select>
            <svg class="pointer-events-none absolute right-2 top-1/2 h-4 w-4 -translate-y-1/2 text-muted" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Story text -->
    <article class="container py-10">
      <div id="story-content" class="story-text mx-auto max-w-[680px] font-serif text-lg leading-[1.9] text-ink">
        {paragraphs.map((words) => (
          <p class="mb-6">
            {words.map((word, i) => (
              <>
                <span
                  class="word cursor-pointer rounded px-[1px] transition-colors duration-150 hover:bg-emerald-100"
                  data-word={normalize(word)}
                >{word}</span>{i < words.length - 1 ? " " : ""}
              </>
            ))}
          </p>
        ))}
      </div>
    </article>

    <!-- Tooltip (hidden by default) -->
    <div
      id="tooltip"
      class="pointer-events-none fixed z-50 opacity-0 transition-opacity duration-150"
      style="top:0;left:0"
    >
      <div class="rounded-xl border border-emerald-200 bg-white px-4 py-3 shadow-lg max-w-[240px]">
        <p id="tooltip-original" class="text-xs font-medium uppercase tracking-wider text-muted"></p>
        <p id="tooltip-translation" class="mt-1 text-base font-semibold text-ink"></p>
      </div>
    </div>
  </main>

  <footer class="border-t border-emerald-100 bg-white">
    <div class="container flex flex-col items-start justify-between gap-4 py-8 text-sm text-muted sm:flex-row sm:items-center">
      <p>&copy; {new Date().getFullYear()} Readerly</p>
      <div class="flex gap-4">
        <a class="hover:text-ink" href="mailto:hello@readerly.ai">Contact</a>
        <span>Privacy available on request</span>
      </div>
    </div>
  </footer>

  <script define:vars={{ translations: story.translations, languages }}>
    // --- State ---
    let currentLang = localStorage.getItem("readerly-lang") || languages[0];
    if (!languages.includes(currentLang)) currentLang = languages[0];

    const tooltip = document.getElementById("tooltip");
    const tooltipOriginal = document.getElementById("tooltip-original");
    const tooltipTranslation = document.getElementById("tooltip-translation");
    let activeWord = null;

    // --- Language switcher ---
    const langSelect = document.getElementById("lang-select");

    function setActiveLang(lang) {
      currentLang = lang;
      localStorage.setItem("readerly-lang", lang);
      langSelect.value = lang;
      // Update tooltip if open
      if (activeWord) {
        showTooltipForWord(activeWord);
      }
    }

    // Restore saved language on load
    setActiveLang(currentLang);

    langSelect.addEventListener("change", () => {
      setActiveLang(langSelect.value);
    });

    // --- Tooltip logic ---
    function showTooltipForWord(span) {
      const word = span.dataset.word;
      const dict = translations[currentLang] || {};
      const translation = dict[word];

      tooltipOriginal.textContent = word;
      if (translation) {
        tooltipTranslation.textContent = translation;
        tooltipTranslation.classList.remove("text-muted", "text-sm");
        tooltipTranslation.classList.add("text-ink", "text-base");
      } else {
        tooltipTranslation.textContent = "no translation available";
        tooltipTranslation.classList.remove("text-ink", "text-base");
        tooltipTranslation.classList.add("text-muted", "text-sm");
      }

      // Position tooltip
      const rect = span.getBoundingClientRect();
      const tooltipEl = tooltip.firstElementChild;
      tooltip.style.opacity = "1";
      tooltip.classList.remove("pointer-events-none");

      // Temporarily show to measure
      tooltip.style.left = "0px";
      tooltip.style.top = "0px";
      const tRect = tooltipEl.getBoundingClientRect();

      let left = rect.left + rect.width / 2 - tRect.width / 2;
      let top = rect.top - tRect.height - 8;

      // Keep within viewport
      if (left < 8) left = 8;
      if (left + tRect.width > window.innerWidth - 8)
        left = window.innerWidth - tRect.width - 8;
      if (top < 8) {
        top = rect.bottom + 8;
      }

      tooltip.style.left = left + "px";
      tooltip.style.top = top + "px";
    }

    function hideTooltip() {
      tooltip.style.opacity = "0";
      tooltip.classList.add("pointer-events-none");
      if (activeWord) {
        activeWord.classList.remove("bg-emerald-200");
        activeWord = null;
      }
    }

    // --- Event listeners ---
    document.getElementById("story-content").addEventListener("click", (e) => {
      const span = e.target.closest(".word");
      if (!span) {
        hideTooltip();
        return;
      }

      // If clicking the same word, toggle off
      if (activeWord === span) {
        hideTooltip();
        return;
      }

      // Deactivate previous
      if (activeWord) {
        activeWord.classList.remove("bg-emerald-200");
      }

      activeWord = span;
      span.classList.add("bg-emerald-200");
      showTooltipForWord(span);
    });

    // Close on click outside
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".word") && !e.target.closest("#tooltip")) {
        hideTooltip();
      }
    });

    // Close on Escape
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") hideTooltip();
    });

    // Reposition on scroll/resize
    function repositionTooltip() {
      if (activeWord) showTooltipForWord(activeWord);
    }
    window.addEventListener("scroll", repositionTooltip, { passive: true });
    window.addEventListener("resize", repositionTooltip, { passive: true });
  </script>
</BaseLayout>
